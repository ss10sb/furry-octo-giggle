<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Integrate Invoice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
    <style>
        @page {
            size: auto;
            margin-left: 0.5in;
            margin-right: 0.5in;
            margin-top: 175px;
            margin-bottom: 150px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            font-family: Arial, sans-serif;
            font-size: 10px;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .d-none {
            display: none;
        }

        .inline-svg {
            height: 1.1em;
            width: 1.1em;
            vertical-align: bottom;
            stroke: black;
        }

        @media print {
            table {
                page-break-after: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            td {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }
        }

        table {
            width: 100%;
            margin-bottom: .5em;
            border-collapse: collapse;
        }

        table td, table th {
            padding-left: 0.25em;
            padding-right: 0.25em;
            padding-top: 0.5em !important;
            padding-bottom: 0.5em !important;
        }

        table th {
            text-align: left;
        }

        .inverse-header {
            background: black;
            color: white;
        }

        .total-label {
            text-align: right;
            font-weight: bold;
        }

        table td.table-number, table th.table-number {
            text-align: right;
        }

        table tfoot {
            border-top: 1px solid black;
        }

        .card {
            width: 100%;
        }

        .card-header {
            font-weight: bold;
            font-size: 1.25em;
        }

        .bg-lightgrey {
            background: #e3e3e3;
        }

        .bg-green {
            background: #009A10;
        }

        .fg-white {
            color: #fff;
        }

        .margin-bottom-1em {
            margin-bottom: 1em;
        }

        .padding-y-50em {
            padding-top: 0.50em;
            padding-bottom: 0.50em;
        }

        .padding-x-25em {
            padding-left: 0.25em;
            padding-right: 0.25em;
        }

        .flex-container {
            display: flex;
            width: 100%;
        }

        .flex-justify-space-between {
            justify-content: space-between;
        }

        .flex-align-start {
            align-items: flex-start;
        }

        .contact div {
            padding-top: .25em;
            padding-bottom: .25em;
        }

    </style>
</head>

<body>
<section class="page">
    <div class="card">
        <div class="card-header bg-green fg-white padding-x-25em padding-y-50em">
            Contact Information
        </div>
        <div class="flex-container flex-justify-space-between margin-bottom-1em">
            <div id="bill-to" class="contact"></div>
            <div id="sold-to" class="contact"></div>
        </div>
    </div>
    <div class="invoice" id="subscriptions-line-items"></div>
</section>
<script id="contact-template" type="text/template">
    <div><%= `${contact.FirstName} ${contact.LastName}` %></div>
    <div><%= contact.Address1 %></div>
    <% if (contact.Address2) { %>
    <div><%= contact.Address2 %></div>
    <% } %>
    <div><%= `${contact.City}, ${contact.State} ${contact.PostalCode}` %></div>
    <div><%= contact.Country %></div>
    <% if (contact.WorkEmail) { %>
    <div>
        <svg class="inline-svg">
            <use href="#email-svg"/>
        </svg>
        <a href="mailto:<%= contact.WorkEmail %>" title="Email <%= contact.WorkEmail %>">
            <%= contact.WorkEmail %>
        </a>
    </div>
    <% } %>
</script>
<script id="bill-to-template" type="text/template">
    <h3>Bill To</h3>
    <div><strong><%= account.Name %></strong></div>
    <% if (account.BillToLegalEntity__c) { %>
    <div><strong><%= account.BillToLegalEntity__c %></strong></div>
    <% } %>
    <div id="bill-to-contact"></div>
    <div>Currency: <%= account.Currency %></div>
</script>
<script id="sold-to-template" type="text-template">
    <h3>Sold To</h3>
    <div><strong><%= account.Name %></strong></div>
    <% if (account.SoldToLegalEntity__c) { %>
    <div><strong><%= account.SoldToLegalEntity__c %></strong></div>
    <% } %>
    <div id="sold-to-contact"></div>
</script>
<script id="subscriptions-line-items-template" type="text/template">
    <table>
        <thead>
        <tr class="card-header bg-green fg-white">
            <th colspan="5">Service Plan Summary</th>
        </tr>
        <tr class="inverse-header">
            <th>Service Name</th>
            <th>Service Period</th>
            <th class="table-number">Unit Price</th>
            <th class="table-number">Quantity</th>
            <th class="table-number">Total</th>
        </tr>
        </thead>
        <% subscriptions.forEach(function(subscription) { %>
        <tbody class="subscription bg-lightgrey">
        <tr>
            <td colspan="5">
                <div class="flex-container flex-justify-space-between flex-align-start">
                    <div><strong>Subscription:</strong> <%= subscription.Name %></div>
                    <div><strong>SO Number:</strong> <%= subscription.SONumber %></div>
                    <div><strong>PO Number:</strong> <%= subscription.PONumber %></div>
                </div>
            </td>
        </tr>
        </tbody>
        <tbody class="line-items">
        <% subscription.LineItems.RatePlanCharges.forEach(function(lineItem) { %>
        <tr>
            <td><%= lineItem.Name %></td>
            <td><%= lineItem.Period %></td>
            <td class="table-number"><%= currency.format(lineItem.Price) %></td>
            <td class="table-number"><%= lineItem.Quantity %></td>
            <td class="table-number"><%= currency.format(lineItem.Total) %></td>
        </tr>
        <% }) %>
        <% subscription.LineItems.Usages.forEach(function(lineItem) { %>
        <tr>
            <td><%= lineItem.Name %></td>
            <td><%= lineItem.Period %></td>
            <td class="table-number">--</td>
            <td class="table-number"><%= lineItem.Quantity %></td>
            <td class="table-number"><%= currency.format(lineItem.Total) %></td>
        </tr>
        <% }) %>
        <tr>
            <td colspan="4" class="total-label">Subtotal</td>
            <td class="table-number"><%= currency.format(subscription.Total) %></td>
        </tr>
        </tbody>
        <% }) %>
        <tfoot id="totals"></tfoot>
    </table>
</script>
<script id="totals-template" type="text/template">
    <tr>
        <td colspan="4" class="total-label">Amount</td>
        <td class="table-number"><%= currency.format(invoice.AmountWithoutTax) %></td>
    </tr>
    <tr>
        <td colspan="4" class="total-label">Tax</td>
        <td class="table-number"><%= currency.format(invoice.TaxAmount) %></td>
    </tr>
    <tr>
        <td colspan="4" class="total-label">Total</td>
        <td class="table-number"><%= currency.format(invoice.Amount) %></td>
    </tr>
</script>
<svg class="d-none">
    <symbol id="email-svg" viewBox="0 0 75 75">
        <path d="M66.097,12.089h-56.9C4.126,12.089,0,16.215,0,21.286v32.722c0,5.071,4.126,9.197,9.197,9.197h56.9
		c5.071,0,9.197-4.126,9.197-9.197V21.287C75.295,16.215,71.169,12.089,66.097,12.089z M61.603,18.089L37.647,33.523L13.691,18.089
		H61.603z M66.097,57.206h-56.9C7.434,57.206,6,55.771,6,54.009V21.457l29.796,19.16c0.04,0.025,0.083,0.042,0.124,0.065
		c0.043,0.024,0.087,0.047,0.131,0.069c0.231,0.119,0.469,0.215,0.712,0.278c0.025,0.007,0.05,0.01,0.075,0.016
		c0.267,0.063,0.537,0.102,0.807,0.102c0.001,0,0.002,0,0.002,0c0.002,0,0.003,0,0.004,0c0.27,0,0.54-0.038,0.807-0.102
		c0.025-0.006,0.05-0.009,0.075-0.016c0.243-0.063,0.48-0.159,0.712-0.278c0.044-0.022,0.088-0.045,0.131-0.069
		c0.041-0.023,0.084-0.04,0.124-0.065l29.796-19.16v32.551C69.295,55.771,67.86,57.206,66.097,57.206z"/>
    </symbol>
</svg>
<script src="https://cdn.jsdelivr.net/npm/ejs@3.1.6/ejs.min.js"></script>
<script src="data.complex.js"></script>
<script>

    const DEBUG = false;

    class Currency {
        /**
         * Create a new currency formatter
         * @param {string} currency 'USD'
         * @param {string} locale 'en-US'
         */
        constructor(currency = 'USD', locale = 'en-US') {
            currency = currency || 'USD';
            locale = locale || 'en-US';
            this.formatter = new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currency
            });
        }

        /**
         * Format a number with the currency formatter
         * @param value
         * @returns {string}
         */
        format(value) {
            value = parseFloat(value);
            return this.formatter.format(value);
        }
    }

    class Subscription {
        /**
         * Creates a subscription object which contains
         * the RatePlanCharges and Usages in a LineItems object
         * @param {object} rawSubscription
         */
        constructor(rawSubscription) {
            this.Name = rawSubscription.Name;
            this.SONumber = rawSubscription.SONumber__c;
            this.PONumber = rawSubscription.PONumber__c;
            this.LineItems = {
                RatePlanCharges: [],
                Usages: []
            };
            this.hasBundle = false;
            if (DEBUG) {
                this.rawSubscription = rawSubscription;
            }
        }

        /**
         * Get subscription subtotal as property (subscription.Total)
         */
        get Total() {
            let sub = 0;
            this.LineItems.RatePlanCharges.forEach(function (rpc) {
                sub += rpc.Total;
            });
            this.LineItems.Usages.forEach(function (u) {
                sub += u.Total;
            });
            return sub;
        }
    }

    /**
     * Base class for the LineItem objects (RatePlanCharge and Usage)
     */
    class LineItem {
        /**
         * @param {string} name
         */
        constructor(name) {
            this.Name = name;
            this.Period = "";
            this.Price = 0;
            this.Quantity = 0;
        }

        /**
         * Adds price to the existing price
         */
        incrementPrice(price) {
            this.Price += parseFloat(price);
        }

        /**
         * Adds quantity to the existing quantity
         */
        incrementQuantity(quantity) {
            this.Quantity += parseInt(quantity);
        }

        /**
         * Get line item total as property (lineItem.Total)
         */
        get Total() {
            return this.Price * this.Quantity;
        }
    }

    /**
     * Override LineItem for the RatePlanCharge LineItem
     */
    class RatePlanCharge extends LineItem {

    }

    /**
     * Override LineItem for the Usage LineItem
     */
    class Usage extends LineItem {

        constructor(name) {
            super(name);
            this.ShortSourceId = null;
            this.total = 0;
        }

        /**
         * Get line item total as property (usage.Total)
         */
        get Total() {
            return this.total;
        }

        /**
         * Adds total to the existing total
         */
        incrementTotal(total) {
            this.total += parseFloat(total);
        }
    }

    /**
     * Generates HTML from templates using the provided engine (EJS)
     */
    class Output {
        /**
         * Create a new Output renderer
         * @param engine
         */
        constructor(engine) {
            this.engine = engine;
        }

        /**
         * Render bill to contact
         * @param {string} containerId
         * @param {object} billTo
         * @param {object} account
         * @param {object} invoice
         */
        billToContact(containerId, billTo, account, invoice) {
            this.render(containerId, {contact: billTo, account: account, invoice: invoice});
            this.renderContact(this.getContactId(containerId), {contact: billTo});
        }

        /**
         * Render sold to contact
         * @param {string} containerId
         * @param {object} soldTo
         * @param {object} account
         * @param {object} invoice
         */
        soldToContact(containerId, soldTo, account, invoice) {
            this.render(containerId, {contact: soldTo, account: account, invoice: invoice});
            this.renderContact(this.getContactId(containerId), {contact: soldTo});
        }

        /**
         * Render subscriptions and line items
         * @param {string} containerId
         * @param {array} subscriptions
         */
        subscriptionsAndLineItems(containerId, subscriptions) {
            this.render(containerId, {subscriptions: subscriptions});
        }

        /**
         * Render invoice totals
         * @param {string} containerId
         * @param {object} invoice
         */
        totals(containerId, invoice) {
            this.render(containerId, {invoice: invoice});
        }

        /**
         * Renders the contact (called from billToContact and soldToContact)
         * @param {string} containerId
         * @param {object} data
         */
        renderContact(containerId, data) {
            const html = this.compile(this.getTemplate(this.getContactTemplateId(containerId)), data);
            this.update(containerId, html);
        }

        /**
         * Compiles HTML using the template and inserts the HTML into the containerId
         * @param {string} containerId
         * @param {object} data
         */
        render(containerId, data) {
            const html = this.compile(this.getTemplate(this.getTemplateId(containerId)), data);
            this.update(containerId, html);
        }

        /**
         * Sets the inner HTML of the container to the html
         * @param {string} containerId
         * @param {string} html
         */
        update(containerId, html) {
            document.getElementById(containerId).innerHTML = html;
        }

        /**
         * Compiles the HTML template using the provided data
         * @param {string} template
         * @param {object} data
         * @returns {string}
         */
        compile(template, data) {
            return this.engine.compile(template)(data);
        }

        /**
         * Specific lookup for the contact template id (used in renderContact)
         * @param {string} containerId
         * @returns {string}
         */
        getContactTemplateId(containerId) {
            return 'contact-template';
        }

        /**
         * Get container ID for the contact based on the containerId
         * @param {string} containerId
         * @returns {string}
         */
        getContactId(containerId) {
            return containerId + '-contact';
        }

        /**
         * Returns the template ID based on the container ID
         * @param {string} containerId
         * @returns {string}
         */
        getTemplateId(containerId) {
            return containerId + '-template';
        }

        /**
         * Retrieves the template HTML by the template ID
         * @param {string} templateId
         * @returns {string}
         */
        getTemplate(templateId) {
            return document.getElementById(templateId).innerHTML;
        }
    }

    /**
     * Retrieve object(s) from the Data object provided by Zuora
     */
    const DataProvider = {
        rawData: {},
        getAccount() {
            return DataProvider.rawData.Account || {};
        },
        getBillToContact() {
            return DataProvider.rawData.BillToContact || {};
        },
        getInvoice() {
            return DataProvider.rawData.Invoice || {};
        },
        getRatePlans() {
            return DataProvider.rawData.RatePlan || [];
        },
        getSoldToContact() {
            return DataProvider.rawData.SoldToContact || {};
        },
        getSubscription() {
            const subscriptions = DataProvider.getSubscriptions();
            if (subscriptions.length) {
                return subscriptions[0];
            }
            return {};
        },
        getSubscriptions() {
            return DataProvider.rawData.Subscription || [];
        }
    };

    /**
     * Sorts the data provided by Zuora into a reasonable hierarchy
     * Subscription
     *   - RatePlans
     *     - RatePlanCharges
     *     - InvoiceItems
     *   - Usages
     */
    const DataSort = {
        addRatePlansForSubscription(subscription, data) {
            const id = subscription.Id || null;
            if (id) {
                let ratePlans = subscription.RatePlans || [];
                const rawRatePlans = data.RatePlan || [];
                rawRatePlans.forEach(function (rp) {
                    DataSort.addRPCsForRatePlan(rp, data);
                    if (rp.SubscriptionId && rp.SubscriptionId === id) {
                        ratePlans.push(rp);
                    }
                });
                subscription.RatePlans = ratePlans;
            }
        },
        addRPCsForRatePlan(ratePlan, data) {
            const id = ratePlan.Id || null;
            if (id) {
                let ratePlanRPCs = ratePlan.RatePlanCharges || [];
                const rpcs = data.RatePlanCharge || [];
                rpcs.forEach(function (rpc) {
                    if (rpc.RatePlanId && rpc.RatePlanId === id) {
                        ratePlanRPCs.push(rpc);
                        DataSort.addInvoiceItemsForRPC(rpc, data);
                    }
                });
                ratePlan.RatePlanCharges = ratePlanRPCs;
            }
        },
        addInvoiceItemsForRPC(rpc, data) {
            const id = rpc.Id || null;
            if (id) {
                let rpcInvoiceItems = rpc.InvoiceItems || [];
                const invoiceItems = data.InvoiceItem || [];
                invoiceItems.forEach(function (ii) {
                    if (ii.RatePlanChargeId && ii.RatePlanChargeId === id) {
                        rpcInvoiceItems.push(ii);
                    }
                });
                rpc.InvoiceItems = rpcInvoiceItems;
            }
        },
        addUsagesForSubscription(subscription, data) {
            const id = subscription.Id || null;
            if (id) {
                let usages = subscription.Usages || [];
                const rawUsages = data.Usage || [];
                rawUsages.forEach(function (usage) {
                    if (usage.SubscriptionId && usage.SubscriptionId === id) {
                        usages.push(usage);
                    }
                })
                subscription.Usages = usages;
            }
        }
    }

    /**
     * Iterate the raw subscriptions (from DataSort), create a subscription object from the raw subscriptions
     * and add the rate plan charge and usage line items for the subscription
     */
    const LineItemsFromSubscriptions = {
        handlers: [],
        getNewSubscription(rawSubscription) {
            return new Subscription(rawSubscription);
        },
        getSubscriptions(rawSubscriptions) {
            let subscriptions = [];
            rawSubscriptions.forEach(function (rawSubscription) {
                let sub = LineItemsFromSubscriptions.getNewSubscription(rawSubscription);
                LineItemsFromSubscriptions.handlers.forEach(function (handler) {
                    handler.handle(sub, rawSubscription);
                });
                subscriptions.push(sub);
            });
            return subscriptions;
        }
    }

    /**
     * Adds RatePlanCharge Line Items to a subscription
     */
    const RatePlanChargeHandler = {
        handle(subscription, rawSubscription) {
            RatePlanChargeHandler.iterateRatePlans(subscription, rawSubscription.RatePlans || []);
        },
        iterateRatePlans(sub, ratePlans) {
            if (RatePlanChargeHandler.shouldBundle(ratePlans)) {
                sub.hasBundle = true;
            }
            RatePlanChargeHandler.ratePlans(sub, ratePlans);
        },
        ratePlans(sub, ratePlans) {
            ratePlans.forEach(function (ratePlan) {
                const ratePlanCharges = ratePlan.RatePlanCharges || [];
                if (RatePlanChargeHandler.isBundle(ratePlan)) {
                    RatePlanChargeHandler.bundledFromRatePlan(sub, ratePlan);
                } else {
                    ratePlanCharges.forEach(function (rpc) {
                        RatePlanChargeHandler.fromRatePlanCharge(sub, rpc);
                    });
                }
            });
        },
        bundledFromRatePlan(sub, ratePlan) {
            const ratePlanCharges = ratePlan.RatePlanCharges || [];
            if (RatePlanChargeHandler.bundleShouldAddRatePlanCharges(ratePlanCharges)) {
                let item = new RatePlanCharge(ratePlan.Name);
                ratePlanCharges.forEach(function (rpc) {
                    RatePlanChargeHandler.setPriceAndQuantity(sub, item, rpc);
                    RatePlanChargeHandler.setPeriod(sub, item, rpc);
                });
                sub.LineItems.RatePlanCharges.push(item);
            }
        },
        fromRatePlanCharge(sub, ratePlanCharge) {
            if (RatePlanChargeHandler.shouldAddRatePlanCharge(ratePlanCharge)) {
                let item = new RatePlanCharge(ratePlanCharge.Name);
                RatePlanChargeHandler.setPeriod(sub, item, ratePlanCharge);
                RatePlanChargeHandler.setPriceAndQuantity(sub, item, ratePlanCharge);
                sub.LineItems.RatePlanCharges.push(item);
            }
        },
        setPeriod(sub, item, ratePlanCharge) {
            if (!item.Period) {
                ratePlanCharge.InvoiceItems.forEach(function (invoiceItem) {
                    item.Period = `${invoiceItem.ServiceStartDate}-${invoiceItem.ServiceEndDate}`;
                    return false;
                });
            }
        },
        setPriceAndQuantity(sub, item, ratePlanCharge) {
            let price = 0;
            let quantity = 0;
            ratePlanCharge.InvoiceItems.forEach(function (ii) {
                price = price + parseFloat(ii.UnitPrice);
                quantity = quantity + parseInt(ii.Quantity);
            });
            item.incrementPrice(price);
            item.Quantity = quantity;
        },
        bundleShouldAddRatePlanCharges(ratePlanCharges) {
            let shouldAdd = true;
            ratePlanCharges.forEach(function (ratePlanCharge) {
                if (RatePlanChargeHandler.isRatePlanChargeUsage(ratePlanCharge)) {
                    shouldAdd = false;
                    return false;
                }
            });
            return shouldAdd;
        },
        shouldAddRatePlanCharge(ratePlanCharge) {
            return !RatePlanChargeHandler.isRatePlanChargeUsage(ratePlanCharge);
        },
        shouldBundle(ratePlans) {
            let has = false;
            ratePlans.forEach(function (ratePlan) {
                if (RatePlanChargeHandler.isBundle(ratePlan)) {
                    has = true;
                    return false;
                }
            });
            return has;
        },
        isBundle(ratePlan) {
            return RatePlanChargeHandler.isBundleByBundleCustomField(ratePlan) || RatePlanChargeHandler.isBundleByRatePlanName(ratePlan);
        },
        isBundleByBundleCustomField(ratePlan) {
            return ratePlan.Bundle__c === 'Yes';
        },
        isBundleByRatePlanName(ratePlan) {
            const name = ratePlan.Name || '';
            return name.startsWith('Bundle:');
        },
        isRatePlanChargeUsage(ratePlanCharge) {
            return ratePlanCharge.ChargeType && ratePlanCharge.ChargeType === 'Usage';
        },
    }

    /**
     * Adds Usage Line Items to a subscription
     */
    const UsageHandler = {
        handle(subscription, rawSubscription) {
            UsageHandler.iterateUsages(subscription, rawSubscription.Usages || []);
        },
        iterateUsages(sub, usages) {
            UsageHandler.bundle(sub, usages);
        },
        bundle(sub, usages) {
            usages = UsageHandler.combineUsages(sub, usages);
            log("Usages", usages);
            for (let bundledUsages of usages.values()) {
                let item = new Usage('Bundled Usage');
                bundledUsages.forEach(function (usage) {
                    item.Name = usage.Alias__c;
                    UsageHandler.setShortSourceId(sub, item, usage);
                    UsageHandler.setPeriod(sub, item, usage);
                    UsageHandler.setPriceQuantityAndTotal(sub, item, usage);
                });
                sub.LineItems.Usages.push(item);
            }
        },
        setShortSourceId(sub, item, usage) {
            if (!item.ShortSourceId) {
                item.ShortSourceId = usage.SourceShortID__c;
            }
        },
        setPeriod(sub, item, usage) {
            if (!item.Period) {
                item.Period = usage.ServicePeriod__c;
            }
        },
        setPriceQuantityAndTotal(sub, item, usage) {
            if (UsageHandler.isBaseProductUOM(usage)) {
                item.incrementQuantity(UsageHandler.getMultiplier(usage) * usage.MarketplaceQuantity__c);
            }
            item.incrementTotal(UsageHandler.getMultiplier(usage) * usage.Quantity);
        },
        combineUsages(sub, usages) {
            let bundled = new Map();
            usages.forEach(function (usage) {
                let id = usage.SourceShortID__c || null;
                if (id) {
                    if (!bundled.has(id)) {
                        bundled.set(id, []);
                    }
                    bundled.get(id).push(usage);
                }
            });
            return bundled;
        },
        getMultiplier(usage) {
            const uom = usage.UOM || '';
            const negatives = ['Refunded'];
            for (let i = 0; i < negatives.length; i++) {
                if (uom.endsWith(negatives[i])) {
                    return -1;
                }
            }
            return 1;
        },
        isBaseProductUOM(usage) {
            const uom = usage.UOM || '';
            const allowedUOMs = ['Marketplace'];
            for (let i = 0; i < allowedUOMs.length; i++) {
                if (uom.startsWith(allowedUOMs[i])) {
                    return true;
                }
            }
            return false;
        }
    }

    /**
     * Create subscriptions array from raw data
     */
    const Subscriptions = {
        getSubscriptionsFromRawSubscriptions(rawSubscriptions) {
            let subscriptions = [];
            rawSubscriptions.forEach(function (subscription) {
                DataSort.addRatePlansForSubscription(subscription, rawData);
                DataSort.addUsagesForSubscription(subscription, rawData);
                subscriptions.push(subscription);
            })
            return subscriptions;
        }
    }

    function log(name, data) {
        if (DEBUG) {
            console.log(name, data);
        }
    }

    //const rawData = {{- Data | to_json -}};

    log('Raw data', rawData);
    DataProvider.rawData = rawData;
    const account = DataProvider.getAccount();
    const currency = new Currency(account.Currency);
    const subscriptions = Subscriptions.getSubscriptionsFromRawSubscriptions(DataProvider.getSubscriptions());
    log('Subscriptions pre-line items', subscriptions);
    LineItemsFromSubscriptions.handlers.push(RatePlanChargeHandler, UsageHandler);
    const subsLineItems = LineItemsFromSubscriptions.getSubscriptions(subscriptions);
    log('Subscriptions w line items', subsLineItems);
    const invoice = DataProvider.getInvoice();
    const output = new Output(ejs);
    output.billToContact('bill-to', DataProvider.getBillToContact(), account, invoice);
    output.soldToContact('sold-to', DataProvider.getSoldToContact(), account, invoice);
    output.subscriptionsAndLineItems('subscriptions-line-items', subsLineItems);
    output.totals('totals', invoice);

</script>
</body>

</html>
